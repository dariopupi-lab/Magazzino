<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Drone Pilot PRO</title>
  <style>
    /* STILI GENERALI */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,Arial,sans-serif;background:#0A2647;color:#fff;min-height:100vh}
    header{background:#0A2647;padding:1.5rem;text-align:center}
    h1{font-size:1.6rem;font-weight:700}
    .subtitle{font-size:.95rem;opacity:.9}
    main{max-width:900px;margin:2rem auto;padding:0 1rem; } 
    .card{background:#fff;color:#1a1a1a;border-radius:18px;overflow:hidden;
          box-shadow:0 15px 35px rgba(10,38,71,.25); width: 100%;} 
    .ateco{background:#144272;color:#fff;padding:1rem;text-align:center;font-weight:600}
    .form{padding:2rem 1.8rem 1.5rem}
    label{display:block;margin:1.4rem 0 .6rem;font-weight:600;font-size:.95rem;color:#2d3748}
    .inline-label {
        font-weight: normal;
        margin: 0;
        font-size: 0.85rem;
        opacity: 0.7;
    }
    input,select{width:100%;padding:1rem 1.1rem;font-size:1.1rem;border:2px solid #e2e8f0;
          border-radius:10px;background:#fcfcfc}
    input:focus,select:focus{border-color:#0A2647;outline:none}
    button{margin-top:2rem;width:100%;padding:1.1rem;font-size:1.2rem;font-weight:700;
           background:#0A2647;color:#fff;border:none;border-radius:10px}
    .ris{display:none;margin:1.8rem;background:#f8fafc;border:1px solid #e2e8f0;
         border-radius:12px;overflow:hidden}
    .r{display:flex;justify-content:space-between;padding:1rem 1.5rem;font-size:1.1rem;
       border-bottom:1px solid #edf2f7}
    .r span:first-child{font-weight:600;color:#2d3748}
    .r b{font-weight:700;font-size:1.15rem}
    .tot{color:#d32f2f}
    .net{color:#2e7d32}
    footer{padding:1.5rem;text-align:center;font-size:.85rem;opacity:.8}
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 1rem;
    }
    .btn-group button {
      margin-top: 0; 
      padding: 0.8rem;
      font-size: 0.9rem;
      font-weight: 600;
      background: #4A5568; 
    }
    .btn-group button:last-child {
      background: #9B2C2C; 
    }
    .input-row {
        margin-bottom: 10px; 
        border: 1px solid #e2e8f0;
        padding: 10px;
        border-radius: 8px;
    }
    .input-row > label {
        margin-top: 0;
        margin-bottom: 5px;
    }
    
    /* STILI PER IL TABBED VIEW */
    .tab-buttons {
        display: flex;
        justify-content: center;
        margin-bottom: 1.5rem;
        gap: 10px;
    }
    .tab-button {
        padding: 0.8rem 1.5rem;
        background: #144272;
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        transition: background 0.2s;
        flex-grow: 1;
        max-width: 250px;
    }
    .tab-button:hover {
        background: #0A2647;
    }
    .tab-button.active {
        background: #FFD700; 
        color: #0A2647;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    
    /* STILI STORICO (TABELLA E AZIONI) */
    .storico-card {
        max-height: 600px;
        overflow-y: auto;
        overflow-x: auto;
    }
    .storico-table {
        width: 100%;
        min-width: 700px;
        border-collapse: collapse;
        font-size: 0.85rem;
        margin-top: 10px;
        color: #1a1a1a;
    }
    .storico-table th, .storico-table td {
        padding: 8px 5px; 
        text-align: right;
        border-bottom: 1px solid #f1f1f1;
    }
    .storico-table tr {
        cursor: pointer; 
        transition: background-color 0.2s;
    }
    .storico-table tr:hover {
        background-color: #f7f7f7;
    }
    .storico-table th {
        white-space: normal; 
    }
    .storico-table th:nth-child(1), .storico-table td:nth-child(1) {
        text-align: left; 
        width: 12%; 
    }
    .storico-table th:nth-child(6), .storico-table td:nth-child(6) {
        /* DA VERSARE */
        font-weight: 700;
        color: #d32f2f; 
    }
    .storico-table th:nth-child(7), .storico-table td:nth-child(7) {
        /* Netto */
        font-weight: 700;
        color: #2e7d32; 
    }
    .storico-table th {
        background: #e9ecef;
        color: #1a1a1a;
        font-weight: 600;
        position: sticky;
        top: 0;
    }
    
    /* Nuovo stile per il riepilogo annuale */
    .summary-section {
        padding: 0 0 10px;
        margin-top: 10px;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
    }
    .summary-section .r {
        padding: 0.8rem 1.5rem; 
        font-size: 1rem;
        border-bottom: 1px solid #f1f1f1;
        font-weight: 600;
    }
    .summary-section .r span:first-child{
        color: #1a1a1a;
        font-weight: 600;
    }
    .summary-section .net, .summary-section .tot {
        font-size: 1.1rem;
        font-weight: 700;
    }
    .summary-section .r:last-child {
         border-bottom: none;
    }
    .storico-table input[type="number"] {
        padding: 5px;
        height: auto;
        font-size: 0.85rem;
        text-align: right;
    }
    /* Stile per i due selettori affiancati */
    .selector-group {
        display: flex;
        gap: 10px;
        width: 100%;
        margin-bottom: 10px;
    }
    .selector-group > div {
        flex-grow: 1;
        min-width: 0;
    }
    
    /* STILI PER IL CALENDARIO TRACKER */
    .calendario-tracker {
        display: grid;
        grid-template-columns: repeat(7, 1fr); /* 7 giorni a settimana */
        gap: 8px;
        /* margin-top: 20px; */ /* Rimosso per usare l'intestazione */
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }
    
    /* NUOVO STILE PER L'INTESTAZIONE DEI GIORNI */
    #intestazione_giorni_tracker {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 20px;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        margin-bottom: 5px; /* Spazio tra intestazione e giorni */
    }
    .giorno-intestazione {
        text-align: center;
        font-weight: 700;
        font-size: 0.9rem;
        color: #1a1a1a; /* Scuro */
        padding: 5px 0;
    }
    
    .giorno-tracker {
        background: #f1f1f1;
        color: #1a1a1a;
        padding: 10px 5px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: background 0.1s;
        aspect-ratio: 1 / 1; /* Rende la casella quadrata */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        user-select: none;
        border: 2px solid #e2e8f0;
    }
    .giorno-tracker.lavorato {
        /* Verde per guadagno pieno (Stato 1) */
        background: #2e7d32; 
        color: #fff;
        border-color: #1b5e20;
    }
    .giorno-tracker.ridotto {
        /* Giallo per guadagno ridotto (Stato 2) */
        background: #FFD700; 
        color: #1a1a1a;
        border-color: #f0c500;
    }
    .giorno-tracker.odierno {
        border: 3px solid #0A2647;
    }
    
    .tracker-summary .r {
        padding: 0.5rem 0;
        font-size: 1rem;
        border-bottom: none;
        justify-content: center;
        gap: 10px;
        color: #1a1a1a;
    }
    .tracker-summary .r span {
        font-weight: 600;
    }
    .tracker-summary .r b {
        font-size: 1.05rem;
    }


  </style>
</head>
<body>
  <header>
    <h1>DRONE PILOT PRO</h1>
    <div class="subtitle">Calcolo tasse e storico mensile – Regime Forfettario</div>
  </header>

  <main>
    
    <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('calcolatore')">
            CALCOLATORE
        </button>
        <button class="tab-button" onclick="switchTab('storico')">
            STORICO ANNUALE
        </button>
        <button class="tab-button" onclick="switchTab('tracker_giorni')">
            TRACKER GIORNI
        </button>
    </div>
    
    <div id="calcolatore" class="tab-content active">
        <div class="card">
            <div class="ateco">
                ATECO 74.20.12 – Riprese aeree con droni
            </div>

            <div class="form">
                
                <label style="margin: 0.8rem 0 0.6rem;">INSERISCI I GUADAGNI MENSILI (DIVISI PER TARIFFA)</label>
                
                <div id="righe_guadagno">
                  </div>
                
                <div class="btn-group">
                    <button type="button" onclick="azzeraCampi()" style="background:#007BFF;">
                        AZZERA TUTTI I CAMPI
                    </button>
                    <button type="button" onclick="rimuoviRiga()">
                        RIMUOVI ULTIMA RIGA
                    </button>
                </div>
                
                <button type="button" onclick="aggiungiRiga()" 
                  style="margin-top:1rem; padding: 0.8rem; background:#144272;">
                  + Aggiungi altra riga
                </button>
                
                <label>Imposta sostitutiva</label>
                <select id="tasse">
                  <option value="0.05">5% (primi 5 anni)</option>
                  <option value="0.15">15% (dopo)</option>
                </select>

                <button onclick="calcola()">CALCOLA NETTO</button>

                <div id="ris" class="ris">
                  <div class="r"><span>Fatturato lordo</span><span>€ <b id="fatt">0</b></span></div>
                  <div class="r"><span>Imponibile (78%)</span><span>€ <b id="imp">0</b></span></div>
                  <div class="r"><span>Tasse</span><span>€ <b id="t">0</b></span></div>
                  <div class="r"><span>INPS (26,07%)</span><span>€ <b id="p">0</b></span></div>
                  <div class="r tot"><span>DA VERSARE</span><span>€ <b id="v">0</b></span></div>
                  <div class="r net"><span>NETTO</span><span>€ <b id="n">0</b></span></div>
                  
                  <div style="padding: 1.5rem; border-top: 1px solid #edf2f7; background: #fff;">
                    <label style="margin: 0 0 0.6rem; color:#0A2647;">SALVA PER:</label>
                    
                    <div class="selector-group">
                        <div>
                            <span class="inline-label" style="opacity:1; color:#1a1a1a;">Mese</span>
                            <select id="mese_storico">
                                </select>
                        </div>
                         <div>
                            <span class="inline-label" style="opacity:1; color:#1a1a1a;">Anno</span>
                            <select id="anno_storico">
                                </select>
                        </div>
                    </div>
                    
                    <button onclick="salvaRisultati()" 
                        style="margin-top:0.5rem; padding: 0.9rem; background:#2e7d32;">
                        SALVA RISULTATI MENSILI
                    </button>
                  </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="storico" class="tab-content">
        
        <div class="card"> 
            <div class="ateco" style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1rem;">
                <span>STORICO ANNUALE:</span>
                <select id="select_anno_storico" onchange="renderStorico()" style="width: auto; padding: 5px 10px; font-size: 1rem; border: none; border-radius: 5px; background: #fff; color: #144272; font-weight: 600;">
                    </select>
            </div>
            
            <div style="padding: 1.2rem 1.2rem 0;">
                <div class="storico-card"> <table class="storico-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">Mese</th>
                                <th>Fatturato €</th>
                                <th>Imponibile €</th>
                                <th>Tasse €</th>
                                <th>INPS €</th>
                                <th>DA VERSARE €</th> 
                                <th>Netto €</th>
                            </tr>
                        </thead>
                        <tbody id="tabella_storico_body">
                            </tbody>
                    </table>
                </div>
                
                <div class="summary-section">
                    <div class="r"><span>Totale Fatturato Lordo Annuo:</span><span id="lordo_annuo_totale">€ 0</span></div>
                    <div class="r"><span>Totale Tasse e INPS Annuali:</span><span id="tasse_annue_totali" class="tot">€ 0</span></div>
                    <div class="r" style="border-bottom: none;"><span>Totale Netto Annuo:</span><span id="netto_annuo_totale" class="net">€ 0</span></div>
                    
                    <div style="text-align: center; padding: 10px 0 0; display: flex; flex-direction: column; align-items: center;">
                        
                        <button onclick="esportaStoricoExcel()" 
                            style="width: 80%; max-width: 400px; padding: 0.6rem 1.2rem; font-size: 0.85rem; background:#2e7d32; margin: 5px auto; border-radius: 8px;">
                            Esporta Storico Annuale in Excel (CSV)
                        </button>
                        
                        <button id="btn_elimina_selezionato" onclick="eliminaMeseSelezionato()" 
                            style="width: 80%; max-width: 400px; padding: 0.6rem 1.2rem; font-size: 0.85rem; background:#9B2C2C; margin: 5px auto; border-radius: 8px;" disabled>
                            Elimina Mese Selezionato
                        </button>
                        
                        <button onclick="cancellaStorico()" 
                            style="width: 80%; max-width: 400px; padding: 0.6rem 1.2rem; font-size: 0.85rem; background:#9B2C2C; margin: 5px auto; border-radius: 8px;">
                            Cancella Storico Completo di questo Anno
                        </button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <div id="tracker_giorni" class="tab-content">
        <div class="card">
            <div class="ateco" style="padding: 0.8rem 1rem; text-align: center;">
                TRACKER GIORNI LAVORATI
            </div>
            <div style="padding: 1.2rem; text-align: center;">
                
                <div class="selector-group" style="margin-bottom: 20px;">
                    <div>
                        <span class="inline-label" style="opacity:1; color:#1a1a1a;">Mese</span>
                        <select id="tracker_mese" onchange="renderTracker()">
                             </select>
                    </div>
                     <div>
                        <span class="inline-label" style="opacity:1; color:#1a1a1a;">Anno</span>
                        <select id="tracker_anno" onchange="renderTracker()">
                             </select>
                    </div>
                </div>
                
                <div id="intestazione_giorni_tracker">
                    <div class="giorno-intestazione">L</div>
                    <div class="giorno-intestazione">M</div>
                    <div class="giorno-intestazione">M</div>
                    <div class="giorno-intestazione">G</div>
                    <div class="giorno-intestazione">V</div>
                    <div class="giorno-intestazione">S</div>
                    <div class="giorno-intestazione">D</div>
                </div>
                
                <div id="calendario_tracker" class="calendario-tracker">
                    </div>
                
                <div style="margin-top: 20px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <span class="inline-label" style="opacity:1; color:#1a1a1a;">Guadagno giornaliero (RIDOTTO) €</span>
                    <input type="number" id="guadagno_ridotto" value="100" step="0.01" placeholder="€ al giorno ridotto" oninput="renderTracker()" style="margin-bottom: 5px;">
                    <span class="inline-label" style="opacity:1; color:#1a1a1a; display: block; margin-top: 10px;">Guadagno giornaliero (PIENO) € (Preso da Calcolatore RIGA 1)</span>
                </div>
                
                <div id="tracker_riepilogo" class="tracker-summary" style="margin-top: 25px;">
                    <div class="r">
                        <span>Totale Giorni Pieno (Verde): </span>
                        <b id="giorni_pieno">0</b>
                    </div>
                    <div class="r">
                        <span>Totale Giorni Ridotto (Giallo): </span>
                        <b id="giorni_ridotto">0</b>
                    </div>
                    <div class="r" style="border-top: 1px solid #e2e8f0; margin-top: 5px;">
                        <span>Fatturato Lordo Mese:</span>
                        <b id="guadagno_lordo_mese" class="net">€ 0</b>
                    </div>
                </div>
                
                <button onclick="resetGiorniMese()" 
                    style="margin-top:1rem; padding: 0.8rem; background:#9B2C2C; max-width: 400px; margin-left: auto; margin-right: auto; display: block; font-size: 0.95rem;">
                    RESET GIORNI MESE CORRENTE
                </button>
                
                <button onclick="copiaGiorniPerCalcolo()" 
                    style="margin-top:1rem; padding: 1rem; background:#144272; max-width: 400px; margin-left: auto; margin-right: auto; display: block;">
                    COPIA GIORNI TOTALI (1a Riga Calcolatore)
                </button>
                
            </div>
        </div>
    </div>
    
  </main>

  <footer>
    Tocca 3 puntini → Aggiungi a schermata Home<br>
    Funziona offline per sempre
  </footer>
  <script>
    let riga_counter = 1; 
    let meseSelezionato = null; // Chiave completa: "ANNO-MESE" (es: "2025-1")
    let annoAttivoStorico = new Date().getFullYear(); // Anno attualmente visualizzato nello storico
    
    // Lista dei mesi
    const mesi = [
        "Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno",
        "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"
    ];
    
    // Variabili Globali e Local Storage
    let risultatiCorrenti = { fatt: 0, imp: 0, tasse: 0, inps: 0, versare: 0, netto: 0 };
    let storicoMensile = JSON.parse(localStorage.getItem('storicoMensileDroni')) || {};
    
    // Variabile per il tracker dei giorni lavorati
    // Struttura: { "2025-10": { "1": 1, "5": 2, "10": 1, ... }, "2025-11": { ... } }
    // Stato: 0=Libero (Default), 1=Lavorato Pieno (Verde), 2=Lavorato Ridotto (Giallo)
    let giorniLavorati = JSON.parse(localStorage.getItem('giorniLavoratiDroni')) || {};

    // ------------------------------------
    // --- Funzioni di Utilità Generali ---
    // ------------------------------------

    // Funzione per formattare i numeri per la visualizzazione (arrotondato a 0 decimali)
    function formattaEuro(numero) {
        const num = Number(numero) || 0;
        // Arrotonda all'intero più vicino e formatta con la localizzazione italiana
        return Math.round(num).toLocaleString('it-IT', { 
            minimumFractionDigits: 0, 
            maximumFractionDigits: 0 
        });
    }
    
    // Funzione per formattare i numeri per il CSV (2 decimali, punto come separatore decimale)
    function formattaCsvNumber(numero) {
        const num = Number(numero) || 0;
        // Usa 2 decimali e punto come separatore decimale per compatibilità CSV/Excel internazionale.
        return num.toFixed(2);
    }

    // Funzione per popolare la select dei mesi (usata dal Calcolatore e Tracker)
    function popolaSelectMesi(selectId) {
        const select = document.getElementById(selectId);
        let options = '';
        mesi.forEach((nome, index) => {
            options += `<option value="${index + 1}">${nome}</option>`;
        });
        select.innerHTML = options;
        
        // Imposta il mese corrente come predefinito
        const oggi = new Date();
        const meseCorrente = oggi.getMonth() + 1; 
        select.value = meseCorrente;
    }
    
    // Funzioni wrapper per popolamento mesi/anni nel calcolatore/tracker
    function popolaSelectMesiCalcolatore() { popolaSelectMesi('mese_storico'); }
    function popolaSelectMesiTracker() { popolaSelectMesi('tracker_mese'); }

    // Funzione per popolare la select degli anni (per il salvataggio e Tracker)
    function popolaSelectAnni(selectId) {
        const select = document.getElementById(selectId);
        const annoCorrente = new Date().getFullYear();
        let options = '';
        
        // Popola con un range di anni
        for (let anno = annoCorrente; anno <= annoCorrente + 5; anno++) {
            options += `<option value="${anno}">${anno}</option>`;
        }
        select.innerHTML = options;
        select.value = annoCorrente; // Imposta l'anno corrente come predefinito
    }

    function popolaSelectAnniCalcolatore() { popolaSelectAnni('anno_storico'); }
    function popolaSelectAnniTracker() { popolaSelectAnni('tracker_anno'); }
    
    // Funzione per popolare la select degli anni (per la visualizzazione dello storico, con filtro robusto)
    function popolaSelectAnniStorico() {
        const select = document.getElementById('select_anno_storico');
        const annoCorrente = new Date().getFullYear();
        
        // 1. Trova tutti gli anni unici presenti nello storico e filtra quelli palesemente errati
        const anniNelloStorico = new Set(Object.keys(storicoMensile)
            .map(chiave => parseInt(chiave.split('-')[0]))
            .filter(anno => anno >= 2020 && anno <= annoCorrente + 5) // Filtro: solo anni tra 2020 e 5 anni nel futuro
        );
        
        // 2. Aggiunge l'anno corrente se non è già presente
        anniNelloStorico.add(annoCorrente);
        
        // 3. Ordina gli anni in ordine decrescente
        const anniOrdinati = Array.from(anniNelloStorico).sort((a, b) => b - a);

        let options = '';
        if (anniOrdinati.length === 0) {
             options += `<option value="${annoCorrente}">${annoCorrente}</option>`;
             annoAttivoStorico = annoCorrente;
        } else {
            anniOrdinati.forEach(anno => {
                options += `<option value="${anno}">${anno}</option>`;
            });
        }
        select.innerHTML = options;
        
        // Tenta di mantenere selezionato l'anno che era attivo
        if (anniOrdinati.includes(annoAttivoStorico) || anniOrdinati.length === 0) {
            select.value = annoAttivoStorico;
        } else if (anniOrdinati.length > 0) {
             // Se l'anno attivo non esiste più (perché cancellato), usa il più recente
             select.value = anniOrdinati[0];
             annoAttivoStorico = anniOrdinati[0];
        }
    }

    // Funzione di inizializzazione
    document.addEventListener('DOMContentLoaded', () => {
        
        // 1. Inizializzazione Calcolatore: Aggiungi la prima riga con i valori di default
        // I valori di default erano: 22 giorni a 180€
        const defaultDays = 22;
        const defaultEarnings = 180;
        aggiungiRigaBase(1, defaultDays, defaultEarnings);
        
        // Inizializzazione Calcolatore/Storico
        popolaSelectMesiCalcolatore();
        popolaSelectAnniCalcolatore();
        popolaSelectAnniStorico(); 
        
        // Inizializzazione Tracker 
        popolaSelectMesiTracker();
        popolaSelectAnniTracker();

        renderStorico();
        switchTab('calcolatore'); // Inizia sulla tab calcolatore
    });

    // ----------------------
    // --- Gestione Tab ---
    // ----------------------

    function switchTab(tabId) {
        // Nasconde tutti i contenuti e disattiva tutti i bottoni
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });

        // Attiva il contenuto e il bottone della tab selezionata
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.tab-button[onclick*="${tabId}"]`).classList.add('active');
        
        // Ricarica la sezione appropriata
        if (tabId === 'storico') {
            popolaSelectAnniStorico(); 
            renderStorico();
        } else if (tabId === 'tracker_giorni') {
             // Aggiorna i selettori e il calendario quando si entra nel tracker
            popolaSelectMesiTracker();
            popolaSelectAnniTracker();
            renderTracker();
        }
    }

    // ------------------------------------------
    // --- Funzioni Calcolatore (Aggiornate) ---
    // ------------------------------------------
    
    // Funzione interna per creare e aggiungere una riga base
    function aggiungiRigaBase(numRiga, giorniValue, guadagnoValue) {
      const container = document.getElementById('righe_guadagno');
      
      const newDiv = document.createElement('div');
      newDiv.className = 'input-row';
      newDiv.id = `riga-${numRiga}`;
      
      const rowLabel = document.createElement('label');
      rowLabel.textContent = `RIGA ${numRiga}`;

      const flexDiv = document.createElement('div');
      flexDiv.style.display = 'flex';
      flexDiv.style.gap = '10px';
      
      const daysContainer = document.createElement('div');
      daysContainer.style.width = '50%';
      daysContainer.innerHTML = '<span class="inline-label">Giorni</span>';
      const inputDays = document.createElement('input');
      inputDays.type = 'number';
      inputDays.className = 'giorni';
      inputDays.placeholder = 'Giorni';
      inputDays.value = giorniValue !== undefined ? giorniValue : 0;
      daysContainer.appendChild(inputDays);

      const earningsContainer = document.createElement('div');
      earningsContainer.style.width = '50%';
      earningsContainer.innerHTML = '<span class="inline-label">Guadagno giornaliero €</span>';
      const inputEarnings = document.createElement('input');
      inputEarnings.type = 'number';
      inputEarnings.className = 'guadagno';
      inputEarnings.placeholder = '€ al giorno';
      inputEarnings.step = '0.01';
      inputEarnings.value = guadagnoValue !== undefined ? guadagnoValue : 0;
      earningsContainer.appendChild(inputEarnings);
      
      flexDiv.appendChild(daysContainer);
      flexDiv.appendChild(earningsContainer);
      
      newDiv.appendChild(rowLabel);
      newDiv.appendChild(flexDiv);
      
      // Rimuovi la riga se già esiste prima di aggiungerla
      const existingRow = document.getElementById(`riga-${numRiga}`);
      if (existingRow) existingRow.remove();

      container.appendChild(newDiv);
      return newDiv;
    }

    function azzeraCampi() {
        if (confirm("Sei sicuro di voler azzerare tutti i campi di Giorni e Guadagno?")) {
            const giorniInput = document.querySelectorAll('.giorni');
            const guadagnoInput = document.querySelectorAll('.guadagno');
            
            giorniInput.forEach(input => input.value = 0);
            guadagnoInput.forEach(input => input.value = 0);
            
            document.getElementById('ris').style.display = 'none';
            // Resetta i risultati correnti
            risultatiCorrenti = { fatt: 0, imp: 0, tasse: 0, inps: 0, versare: 0, netto: 0 };
        }
    }

    function rimuoviRiga() {
        const container = document.getElementById('righe_guadagno');
        
        // Cerca l'ultima riga esistente in base al DOM, non solo al counter
        let ultimaRiga = document.getElementById(`riga-${riga_counter}`);
        while (!ultimaRiga && riga_counter > 1) {
            riga_counter--;
            ultimaRiga = document.getElementById(`riga-${riga_counter}`);
        }
        
        if (riga_counter > 1) { // Permette di rimuovere se ci sono più di 1 riga
            if(ultimaRiga) ultimaRiga.remove();
            
            // Trova il nuovo riga_counter (il massimo ID di riga rimasto)
            const righeDom = document.querySelectorAll('#righe_guadagno .input-row');
            // Assicurati che se rimane solo riga-1, il counter sia 1
            riga_counter = righeDom.length > 0 ? parseInt(righeDom[righeDom.length - 1].id.split('-')[1]) : 1;
            
            document.getElementById('ris').style.display = 'none';
        } else {
            alert("È necessario mantenere almeno una riga di inserimento.");
        }
    }

    function aggiungiRiga() {
      riga_counter++;
      aggiungiRigaBase(riga_counter);
    }

    function calcola(){
        try {
            const t = parseFloat(document.getElementById('tasse').value);
            let fatturatoTotale = 0;

            const giorniInput = document.querySelectorAll('.giorni');
            const guadagnoInput = document.querySelectorAll('.guadagno');

            for (let i = 0; i < giorniInput.length; i++) {
              const giorni = parseFloat(giorniInput[i].value) || 0;
              const guadagno = parseFloat(guadagnoInput[i].value) || 0;
              
              fatturatoTotale += giorni * guadagno;
            }
            
            const fatt = fatturatoTotale;
            
            // Calcoli
            const imp  = fatt * 0.78;
            const tasse = imp * t;
            const inps  = imp * 0.2607;
            
            const versare = tasse + inps;
            const netto = fatt - versare;

            // Aggiorna variabile globale risultatiCorrenti
            risultatiCorrenti = { fatt, imp, tasse, inps, versare, netto };

            // Visualizzazione dei risultati
            document.getElementById('fatt').textContent = formattaEuro(fatt);
            document.getElementById('imp').textContent  = formattaEuro(imp);
            document.getElementById('t').textContent = formattaEuro(tasse);
            document.getElementById('p').textContent = formattaEuro(inps);
            document.getElementById('v').textContent = formattaEuro(versare);
            document.getElementById('n').textContent = formattaEuro(netto);
            document.getElementById('ris').style.display = 'block';

        } catch (error) {
            console.error("Errore critico nel calcolo:", error);
            alert("Si è verificato un errore nel calcolo. Controlla i campi inseriti e riprova.");
        }
    }
    
    // ------------------------------------
    // --- Funzioni per la Gestione Storico ---
    // ------------------------------------

    function salvaRisultati() {
        if (risultatiCorrenti.fatt === 0) {
            alert("Il Fatturato Lordo è zero. Calcola prima i risultati.");
            return;
        }

        const meseIndex = document.getElementById('mese_storico').value; // 1-12
        const anno = document.getElementById('anno_storico').value;
        const chiave = `${anno}-${meseIndex}`; // Nuova chiave: ANNO-MESE
        
        storicoMensile[chiave] = {
            mese: mesi[meseIndex - 1], // Nome del mese
            anno: parseInt(anno),
            fatt: risultatiCorrenti.fatt,
            imp: risultatiCorrenti.imp,
            tasse: risultatiCorrenti.tasse,
            inps: risultatiCorrenti.inps,
            versare: risultatiCorrenti.versare, 
            netto: risultatiCorrenti.netto
        };

        // Salva nel Local Storage
        localStorage.setItem('storicoMensileDroni', JSON.stringify(storicoMensile));
        
        // Imposta l'anno di visualizzazione sullo storico appena salvato
        annoAttivoStorico = parseInt(anno); 
        
        popolaSelectAnniStorico(); // Aggiorna la lista anni se necessario
        renderStorico(); // Ricarica la tabella
        alert(`Risultati salvati per ${mesi[meseIndex - 1]} ${anno}!`);
        switchTab('storico'); // Passa automaticamente allo storico
    }
    
    function selezionaMese(chiave, rowElement) {
        // Rimuovi l'evidenziazione da tutte le righe
        document.querySelectorAll('#tabella_storico_body tr').forEach(row => {
            row.style.backgroundColor = ''; 
            row.classList.remove('active-row');
        });
        
        // Seleziona la nuova riga
        meseSelezionato = chiave;
        rowElement.style.backgroundColor = '#fff3cd'; // Colore per evidenziare
        rowElement.classList.add('active-row');
        
        // Aggiorna il bottone Elimina
        const datiSelezionati = storicoMensile[chiave];
        document.getElementById('btn_elimina_selezionato').disabled = false;
        document.getElementById('btn_elimina_selezionato').textContent = `Elimina Mese Selezionato (${datiSelezionati.mese} ${datiSelezionati.anno})`;
    }

    function eliminaMeseSelezionato() {
        if (meseSelezionato === null) {
            alert("Seleziona prima un mese dalla tabella.");
            return;
        }

        const nomeMeseAnno = `${storicoMensile[meseSelezionato].mese} ${storicoMensile[meseSelezionato].anno}`;
        if (confirm(`Sei sicuro di voler eliminare i dati del mese di ${nomeMeseAnno}?`)) {
            // Logica di eliminazione
            delete storicoMensile[meseSelezionato];
            localStorage.setItem('storicoMensileDroni', JSON.stringify(storicoMensile));
            
            // Reset selezione e re-render
            meseSelezionato = null;
            document.getElementById('btn_elimina_selezionato').disabled = true;
            document.getElementById('btn_elimina_selezionato').textContent = `Elimina Mese Selezionato`;
            
            popolaSelectAnniStorico(); // Ricontrolla se l'anno ha ancora dati
            renderStorico();
            alert(`Dati di ${nomeMeseAnno} eliminati con successo.`);
        }
    }

    // Funzione per l'esportazione dello storico annuale in CSV
    function esportaStoricoExcel() {
        const anno = annoAttivoStorico; // Usa l'anno correntemente visualizzato
        
        const chiaviMesiAnnoAttivo = Object.keys(storicoMensile)
            .filter(chiave => chiave.startsWith(`${anno}-`))
            .sort((a, b) => {
                // Ordina per mese (il numero dopo il trattino)
                return parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]);
            });
            
        if (chiaviMesiAnnoAttivo.length === 0) {
            alert(`Nessun dato storico per l'anno ${anno} da esportare.`);
            return;
        }

        // Usa il punto e virgola come delimitatore per facilitare l'apertura in Excel Europeo
        let csvContent = "Mese;Fatturato Lordo (€);Imponibile (78%) (€);Tasse (€);INPS (26,07%) (€);DA VERSARE (€);NETTO (€)\n";
        
        let totaleLordoAnnuo = 0;
        let totaleTasseAnnue = 0;
        let totaleNettoAnnuo = 0;

        chiaviMesiAnnoAttivo.forEach(chiave => {
            const dati = storicoMensile[chiave];
            const daVersare = (dati.tasse || 0) + (dati.inps || 0); 

            // Aggiorna totali
            totaleLordoAnnuo += dati.fatt;
            totaleTasseAnnue += daVersare;
            totaleNettoAnnuo += dati.netto;
            
            // Riga CSV per il mese
            csvContent += `${dati.mese};`
                        + `${formattaCsvNumber(dati.fatt)};`
                        + `${formattaCsvNumber(dati.imp)};`
                        + `${formattaCsvNumber(dati.tasse)};`
                        + `${formattaCsvNumber(dati.inps)};`
                        + `${formattaCsvNumber(daVersare)};`
                        + `${formattaCsvNumber(dati.netto)}\n`;
        });
        
        // Aggiungi la riga del totale annuale
        csvContent += `\nTOTALE ANNUALE;`
                    + `${formattaCsvNumber(totaleLordoAnnuo)};`
                    + `N/A;N/A;N/A;`
                    + `${formattaCsvNumber(totaleTasseAnnue)};`
                    + `${formattaCsvNumber(totaleNettoAnnuo)}\n`;

        // Crea un oggetto Blob e un URL per il download
        // Aggiungo il BOM (Byte Order Mark) per correggere la codifica UTF-8 in Excel su Windows
        const BOM = "\uFEFF";
        const blob = new Blob([BOM + csvContent], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `DronePilotPro_Storico_${anno}.csv`;
        document.body.appendChild(a);
        a.click();
        
        // Pulizia
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function renderStorico() {
        // 1. Aggiorna l'anno attivo se il selettore esiste
        const selectAnno = document.getElementById('select_anno_storico');
        if (selectAnno) {
            annoAttivoStorico = parseInt(selectAnno.value);
        }
        
        // 2. CHECK DI ROBUSTEZZA: Se il mese selezionato non appartiene all'anno attivo, annulla la selezione.
        if (meseSelezionato && !meseSelezionato.startsWith(`${annoAttivoStorico}-`)) {
            meseSelezionato = null;
        }
        
        const tabellaBody = document.getElementById('tabella_storico_body');
        tabellaBody.innerHTML = '';
        
        const lordoAnnuoDisplay = document.getElementById('lordo_annuo_totale');
        const tasseAnnueDisplay = document.getElementById('tasse_annue_totali');
        const nettoAnnuoDisplay = document.getElementById('netto_annuo_totale');
        
        let totaleNettoAnnuo = 0;
        let totaleLordoAnnuo = 0; 
        let totaleTasseAnnue = 0; 
        
        // 3. Reset del pulsante Elimina esterno (dopo il check di robustezza)
        document.getElementById('btn_elimina_selezionato').disabled = true;
        document.getElementById('btn_elimina_selezionato').textContent = `Elimina Mese Selezionato`;
        
        // Filtra e ordina solo i mesi dell'anno attivo (chiavi complete: ANNO-MESE)
        const chiaviMesiAnnoAttivo = Object.keys(storicoMensile)
            .filter(chiave => chiave.startsWith(`${annoAttivoStorico}-`))
            .sort((a, b) => {
                // Ordina per mese (il numero dopo il trattino)
                return parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]);
            });
        
        chiaviMesiAnnoAttivo.forEach(chiave => {
            const dati = storicoMensile[chiave];
            const daVersare = (dati.tasse || 0) + (dati.inps || 0); 
            
            const newRow = document.createElement('tr');
            newRow.id = `storico-row-${chiave}`;
            newRow.setAttribute('onclick', `selezionaMese('${chiave}', this)`); // Passa la chiave completa
            
            // Evidenzia il mese selezionato se presente
            if (chiave === meseSelezionato) {
                 newRow.style.backgroundColor = '#fff3cd';
                 document.getElementById('btn_elimina_selezionato').disabled = false;
                 document.getElementById('btn_elimina_selezionato').textContent = `Elimina Mese Selezionato (${dati.mese} ${dati.anno})`;
            }
            
            newRow.innerHTML = `
                <td>${dati.mese}</td>
                <td data-campo="fatt">${formattaEuro(dati.fatt)}</td>
                <td data-campo="imp">${formattaEuro(dati.imp)}</td>
                <td data-campo="tasse">${formattaEuro(dati.tasse)}</td>
                <td data-campo="inps">${formattaEuro(dati.inps)}</td>
                <td data-campo="versare" class="tot"><b>${formattaEuro(daVersare)}</b></td> 
                <td data-campo="netto" class="net"><b>${formattaEuro(dati.netto)}</b></td>
            `;
            tabellaBody.appendChild(newRow);
            
            // Aggiornamento Totali Annuali
            totaleNettoAnnuo += dati.netto;
            totaleLordoAnnuo += dati.fatt;
            totaleTasseAnnue += daVersare;
        });
        
        // Visualizzazione dei Totali Annuali
        lordoAnnuoDisplay.textContent = `€ ${formattaEuro(totaleLordoAnnuo)}`;
        tasseAnnueDisplay.textContent = `€ ${formattaEuro(totaleTasseAnnue)}`;
        nettoAnnuoDisplay.textContent = `€ ${formattaEuro(totaleNettoAnnuo)}`;
        
        // Se non ci sono dati, aggiunge una riga di placeholder
        if (chiaviMesiAnnoAttivo.length === 0) {
             tabellaBody.innerHTML = `<tr><td colspan="7" style="text-align:center; opacity:0.6; padding: 15px;">Nessun dato salvato per l'anno ${annoAttivoStorico}.</td></tr>`;
        }
        
        // Aggiorna il testo del pulsante "Cancella Storico Completo"
        document.querySelector('#storico button[onclick="cancellaStorico()"]').textContent = `Cancella Storico Completo di ${annoAttivoStorico}`;
    }
    
    function cancellaStorico() {
        if (confirm(`ATTENZIONE! Sei sicuro di voler cancellare TUTTI i dati salvati per l'anno ${annoAttivoStorico}? Questa operazione è irreversibile.`)) {
            
            // Trova e rimuovi tutte le chiavi relative all'anno attivo
            Object.keys(storicoMensile)
                .filter(chiave => chiave.startsWith(`${annoAttivoStorico}-`))
                .forEach(chiave => delete storicoMensile[chiave]);

            localStorage.setItem('storicoMensileDroni', JSON.stringify(storicoMensile));
            
            meseSelezionato = null; // Reset selezione
            popolaSelectAnniStorico(); // Rimuove l'anno dalla lista se vuoto
            renderStorico(); 
            alert(`Storico completo per l'anno ${annoAttivoStorico} cancellato con successo!`);
        }
    }

    // ------------------------------------
    // --- Funzioni per il Tracker Giorni ---
    // ------------------------------------
    
    // Aggiunge/Rimuove un giorno dalla lista dei giorni lavorati
    // Stato: 0=Libero (Default), 1=Lavorato Pieno (Verde), 2=Lavorato Ridotto (Giallo)
    function toggleGiorno(giorno) {
        const mese = document.getElementById('tracker_mese').value;
        const anno = document.getElementById('tracker_anno').value;
        const chiave = `${anno}-${mese}`;
        
        // Inizializza l'oggetto se non esiste
        if (!giorniLavorati[chiave]) {
            giorniLavorati[chiave] = {};
        }
        
        const statoCorrente = giorniLavorati[chiave][giorno] || 0;
        let nuovoStato = 0;
        
        if (statoCorrente === 0) {
            nuovoStato = 1; // Passa a Pieno (Verde)
        } else if (statoCorrente === 1) {
            nuovoStato = 2; // Passa a Ridotto (Giallo)
        } else {
            nuovoStato = 0; // Torna a Libero (Grigio/Default)
        }
        
        if (nuovoStato === 0) {
            // Se lo stato è Libero, rimuovi la chiave
            delete giorniLavorati[chiave][giorno];
        } else {
            giorniLavorati[chiave][giorno] = nuovoStato;
        }
        
        localStorage.setItem('giorniLavoratiDroni', JSON.stringify(giorniLavorati));
        renderTracker(); // Ridisegna per aggiornare
    }
    
    // Resetta tutti i giorni lavorati per il mese attualmente visualizzato
    function resetGiorniMese() {
        const mese = document.getElementById('tracker_mese').value;
        const anno = document.getElementById('tracker_anno').value;
        const chiave = `${anno}-${mese}`;
        const nomeMese = mesi[parseInt(mese) - 1];

        if (confirm(`Sei sicuro di voler resettare tutti i giorni lavorati per ${nomeMese} ${anno}? L'operazione è irreversibile.`)) {
            
            // Elimina i dati per il mese selezionato
            delete giorniLavorati[chiave];
            
            localStorage.setItem('giorniLavoratiDroni', JSON.stringify(giorniLavorati));
            
            renderTracker();
            alert(`Giorni lavorati per ${nomeMese} ${anno} resettati con successo.`);
        }
    }
    
    // Disegna il calendario e calcola il resoconto
    function renderTracker() {
        const meseIndex = parseInt(document.getElementById('tracker_mese').value); // 1-12
        const anno = parseInt(document.getElementById('tracker_anno').value);
        const calendarioDiv = document.getElementById('calendario_tracker');
        const chiave = `${anno}-${meseIndex}`;
        
        calendarioDiv.innerHTML = '';
        
        const oggi = new Date();
        const giornoCorrente = oggi.getDate();
        const meseCorrente = oggi.getMonth() + 1;
        const annoCorrente = oggi.getFullYear();
        
        // Calcola il numero di giorni nel mese
        const giorniNelMese = new Date(anno, meseIndex, 0).getDate(); 
        
        // Ottieni l'oggetto dei giorni lavorati per il mese attivo, altrimenti oggetto vuoto
        const statiGiorniMese = giorniLavorati[chiave] || {};
        
        // Variabili per il resoconto
        let giorniPieno = 0;
        let giorniRidotto = 0;
        
        // Calcola l'offset del primo giorno della settimana 
        // 0=Lun, 1=Mar, ..., 6=Dom (dove .getDay() restituisce 0=Dom, 1=Lun, ..., 6=Sab)
        const primoGiornoSettimana = (new Date(anno, meseIndex - 1, 1).getDay() + 6) % 7; 
        
        // 1. Aggiungi i giorni vuoti di placeholder
        for (let i = 0; i < primoGiornoSettimana; i++) {
            const placeholder = document.createElement('div');
            placeholder.className = 'giorno-tracker';
            placeholder.style.backgroundColor = 'transparent';
            placeholder.style.border = 'none';
            placeholder.textContent = '';
            calendarioDiv.appendChild(placeholder);
        }
        
        // 2. Aggiungi i giorni del mese
        for (let giorno = 1; giorno <= giorniNelMese; giorno++) {
            const giornoDiv = document.createElement('div');
            giornoDiv.className = 'giorno-tracker';
            giornoDiv.textContent = giorno;
            giornoDiv.setAttribute('onclick', `toggleGiorno(${giorno})`);
            
            const stato = statiGiorniMese[giorno] || 0;
            
            // Applica la classe in base allo stato
            if (stato === 1) {
                giornoDiv.classList.add('lavorato'); // Verde (Pieno)
                giorniPieno++;
            } else if (stato === 2) {
                giornoDiv.classList.add('ridotto'); // Giallo (Ridotto)
                giorniRidotto++;
            }
            
            // Check se è il giorno odierno
            if (giorno === giornoCorrente && meseIndex === meseCorrente && anno === annoCorrente) {
                giornoDiv.classList.add('odierno');
            }
            
            calendarioDiv.appendChild(giornoDiv);
        }
        
        // 3. Calcola e Aggiorna Resoconto
        
        // Recupera il guadagno giornaliero pieno dalla prima riga del Calcolatore
        const guadagnoPienoElement = document.querySelector('#riga-1 .guadagno');
        const guadagnoPieno = parseFloat(guadagnoPienoElement ? guadagnoPienoElement.value : 0) || 0;

        // Recupera il guadagno giornaliero ridotto dal nuovo campo del Tracker
        const guadagnoRidotto = parseFloat(document.getElementById('guadagno_ridotto').value) || 0;
        
        const lordoMese = (giorniPieno * guadagnoPieno) + (giorniRidotto * guadagnoRidotto);
        
        document.getElementById('giorni_pieno').textContent = giorniPieno;
        document.getElementById('giorni_ridotto').textContent = giorniRidotto;
        document.getElementById('guadagno_lordo_mese').textContent = `€ ${formattaEuro(lordoMese)}`;
        
    }
    
    // Copia i giorni spuntati nel campo del calcolatore (Logica Aggiornata)
    function copiaGiorniPerCalcolo() {
        const mese = document.getElementById('tracker_mese').value;
        const anno = document.getElementById('tracker_anno').value;
        const chiave = `${anno}-${mese}`;
        
        const statiGiorniMese = giorniLavorati[chiave] || {};
        
        let giorniPieno = 0;
        let giorniRidotto = 0;
        
        Object.values(statiGiorniMese).forEach(stato => {
            if (stato === 1) giorniPieno++;
            if (stato === 2) giorniRidotto++;
        });
        
        // Recupera il guadagno giornaliero pieno dalla prima riga del Calcolatore
        const guadagnoPienoElement = document.querySelector('#riga-1 .guadagno');
        const guadagnoPieno = parseFloat(guadagnoPienoElement ? guadagnoPienoElement.value : 0) || 0;
        
        // Recupera il guadagno giornaliero ridotto dal campo del Tracker
        const guadagnoRidotto = parseFloat(document.getElementById('guadagno_ridotto').value) || 0;
        
        // --- LOGICA AGGIORNATA ---
        
        // 1. Pulisci e Ricrea la Riga 1 (Pieno)
        const container = document.getElementById('righe_guadagno');
        container.innerHTML = ''; // Pulisce tutte le righe
        
        // Ricrea la Riga 1 pulita (come riga "Pieno")
        aggiungiRigaBase(1, giorniPieno, guadagnoPieno);
        let alertMessage = `Riga 1 (Pieno): ${giorniPieno} giorni a €${guadagnoPieno} al giorno.`;
        riga_counter = 1; // Reimposta il counter
        
        // 2. Aggiungi la Riga 2 (Ridotto) se necessario
        if (giorniRidotto > 0) {
            riga_counter = 2; // Imposta il counter alla riga 2
            aggiungiRigaBase(2, giorniRidotto, guadagnoRidotto);
            alertMessage += `\nRiga 2 (Ridotto): ${giorniRidotto} giorni a €${guadagnoRidotto} al giorno.`;
        }
        
        // Rimuovi eventuali righe oltre la nuova riga_counter
        let i = riga_counter + 1;
        let rowToRemove = document.getElementById(`riga-${i}`);
        while (rowToRemove) {
             rowToRemove.remove();
             i++;
             rowToRemove = document.getElementById(`riga-${i}`);
        }

        alert(`Dati copiati e righe aggiornate nel Calcolatore:\n\n${alertMessage}`);
        switchTab('calcolatore');
    }
    
  </script>
</body>
</html>
